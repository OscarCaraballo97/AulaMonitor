<ion-header>
  <ion-toolbar color="primary" class="dark:bg-kwd-darker">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/app/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title class="dark:text-kwd-light">Mi Perfil</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleEditMode()" *ngIf="!isEditing && currentUser">
        <ion-icon slot="icon-only" name="create-outline" aria-label="Editar Perfil"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding bg-gray-100 dark:bg-kwd-dark">
  <div *ngIf="!currentUser && !isLoading" class="text-center py-8">
    <p class="text-gray-500 dark:text-gray-400">No se pudo cargar la informaci칩n del perfil.</p>
  </div>
  <div *ngIf="isLoading && !currentUser" class="text-center py-8">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando perfil...</p>
  </div>

  <div *ngIf="currentUser" class="max-w-lg mx-auto bg-white dark:bg-kwd-darker shadow-xl rounded-lg p-6">
    <div class="flex flex-col items-center">
      
      <div *ngIf="!isEditing" class="text-center w-full mt-4"> 
        <h1 class="text-3xl font-bold text-gray-800 dark:text-kwd-light">{{ currentUser.name }}</h1>
        <p class="text-md text-gray-600 dark:text-gray-400 mt-1">{{ currentUser.email }}</p>
        <p class="text-md text-gray-500 dark:text-gray-500 mt-1 capitalize">{{ currentUser.role.toLowerCase() }}</p>
        
        <div class="mt-6 w-full">
          <ion-button expand="block" (click)="toggleEditMode()" class="mb-2">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Editar Perfil
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="changePassword()">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            Cambiar Contrase침a
          </ion-button>
        </div>
      </div>

      <form *ngIf="isEditing" [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="w-full mt-6 space-y-4">
        <ion-item lines="inset" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
          <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Nombre Completo <span class="text-red-500">*</span></ion-label>
          <ion-input formControlName="name" type="text" placeholder="Tu nombre completo"
                     class="text-gray-900 dark:text-kwd-light"
                     [ngClass]="{'ion-invalid ion-touched': profileForm.get('name')?.invalid && profileForm.get('name')?.touched}">
          </ion-input>
        </ion-item>
        <div *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched" class="text-xs text-red-600 dark:text-kwd-red px-1">
          <small *ngIf="profileForm.get('name')?.errors?.['required']">El nombre es requerido.</small>
        </div>

        <ion-item lines="inset" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
          <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Correo Electr칩nico <span class="text-red-500">*</span></ion-label>
          <ion-input formControlName="email" type="email" placeholder="tu@correo.com"
                     class="text-gray-900 dark:text-kwd-light"
                     [ngClass]="{'ion-invalid ion-touched': profileForm.get('email')?.invalid && profileForm.get('email')?.touched}">
          </ion-input>
        </ion-item>
        <div *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched" class="text-xs text-red-600 dark:text-kwd-red px-1">
          <small *ngIf="profileForm.get('email')?.errors?.['required']">El correo es requerido.</small>
          <small *ngIf="profileForm.get('email')?.errors?.['email']">Ingresa un correo v치lido.</small>
        </div>
        
        <ion-item lines="none" class="rounded-md bg-gray-100 dark:bg-kwd-dark-light">
          <ion-label position="stacked" class="text-gray-600 dark:text-gray-400">Rol:</ion-label>
          <ion-input [value]="currentUser.role.toLowerCase() | titlecase" readonly class="text-gray-800 dark:text-kwd-light"></ion-input>
        </ion-item>

        <div class="mt-6 flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3">
          <ion-button type="button" fill="outline" (click)="toggleEditMode()" color="medium" class="dark:text-gray-300 dark:border-gray-600">
            <ion-icon name="close-circle-outline" slot="start"></ion-icon>
            Cancelar
          </ion-button>
          <ion-button type="submit" [disabled]="profileForm.invalid || isLoading" color="primary" class="dark:text-white">
            <ion-spinner *ngIf="isLoading" name="dots" class="mr-2"></ion-spinner>
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Guardar Cambios
          </ion-button>
        </div>
      </form>
    </div>
  </div>
</ion-content>