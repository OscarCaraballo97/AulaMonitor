<ion-header class="md:hidden">
  <ion-toolbar color="primary" class="dark:bg-kwd-darker">
    <ion-buttons slot="start">
      <ion-menu-button menu="kwd-sidebar"></ion-menu-button>
    </ion-buttons>
    <ion-title class="dark:text-kwd-light">Reservas</ion-title>
    <ion-buttons slot="end" *ngIf="canCreateReservation()">
      <ion-button (click)="navigateToAddReservation()">
        <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-gray-100 dark:bg-kwd-dark">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="p-4 md:p-6 lg:p-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
      <h1 class="text-2xl font-semibold text-gray-800 dark:text-kwd-light">
        {{ userRole === RolEnum.ADMIN ? 'Gesti贸n de Reservas' : 'Mis Reservas' }}
      </h1>
      <div class="mt-4 md:mt-0 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
        <ion-item *ngIf="userRole === RolEnum.ADMIN" class="flex-1 rounded-md shadow-sm dark:bg-kwd-darker">
          <ion-label position="stacked" class="text-xs dark:text-gray-300">Filtrar por Estado</ion-label>
          <ion-select [(ngModel)]="filterStatus" (ionChange)="onFilterChange()" interface="popover" class="dark:text-kwd-light">
            <ion-select-option *ngFor="let item of allStatusesForFilter" [value]="item.value">{{ item.display }}</ion-select-option>
          </ion-select>
        </ion-item>
        <button *ngIf="canCreateReservation()" (click)="navigateToAddReservation()"
                class="flex items-center justify-center px-4 py-2 text-sm font-medium text-white rounded-md bg-kwd-blue-DEFAULT hover:bg-kwd-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-kwd-blue-500 dark:bg-kwd-blue-600 dark:hover:bg-kwd-blue-700">
          <ion-icon name="add-outline" class="w-5 h-5 mr-2"></ion-icon>
          Nueva Reserva
        </button>
      </div>
    </div>

    <div *ngIf="userRole === RolEnum.ADMIN" class="mb-8">
      <ion-button expand="block" fill="outline" (click)="togglePendingSection()" class="mb-3">
        <ion-icon [name]="showPendingSection ? 'chevron-up-outline' : 'chevron-down-outline'" slot="start"></ion-icon>
        {{ showPendingSection ? 'Ocultar' : 'Ver' }} Reservas Pendientes ({{ pendingReservations.length }})
        <ion-spinner *ngIf="isLoadingPending && showPendingSection" name="dots" slot="end" class="ml-2"></ion-spinner>
      </ion-button>

      <div *ngIf="showPendingSection">
        <div *ngIf="isLoadingPending && pendingReservations.length === 0" class="p-4 text-center text-gray-500 dark:text-gray-400">
          <ion-spinner name="dots"></ion-spinner> <p>Cargando reservas pendientes...</p>
        </div>
        <div *ngIf="!isLoadingPending && pendingReservations.length === 0" class="p-4 text-center text-gray-500 bg-white rounded-lg shadow-md dark:bg-kwd-darker dark:text-gray-400">
          No hay reservas pendientes de aprobaci贸n.
        </div>
        <ion-list *ngIf="!isLoadingPending && pendingReservations.length > 0" class="rounded-lg shadow-md dark:bg-kwd-darker">
          <ion-item *ngFor="let res of pendingReservations" lines="full" class="dark:bg-kwd-darker dark:text-kwd-light">
            <ion-label>
              <h2 class="font-semibold">{{ res.classroom?.name || res.classroomId }}</h2>
              <p>Solicitante: {{ res.user?.name || res.user?.email || res.userId }}</p>
              <p>Desde: {{ res.startTime | date:'dd/MM/yy HH:mm' }} Hasta: {{ res.endTime | date:'HH:mm' }}</p>
              <p *ngIf="res.purpose" class="text-xs text-gray-500 dark:text-gray-400">Prop贸sito: {{ res.purpose }}</p>
            </ion-label>
            <div slot="end" class="flex flex-col items-end space-y-1 md:flex-row md:space-y-0 md:space-x-2">
              <ion-button size="small" fill="outline" color="success" (click)="confirmAction(res, 'approve', 'pending')">
                <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>Aprobar
              </ion-button>
              <ion-button size="small" fill="outline" color="danger" (click)="confirmAction(res, 'reject', 'pending')">
                <ion-icon slot="start" name="ban-outline"></ion-icon>Rechazar
              </ion-button>
            </div>
          </ion-item>
        </ion-list>
      </div>
    </div>

    <h2 *ngIf="userRole !== RolEnum.ADMIN" class="text-xl font-semibold text-gray-700 dark:text-kwd-light mb-3">
      {{ filterStatus ? (filterStatus | titlecase) + 's' : 'Todas Mis Reservas' }}
    </h2>
     <h2 *ngIf="userRole === RolEnum.ADMIN" class="text-xl font-semibold text-gray-700 dark:text-kwd-light mb-3">
      {{ filterStatus ? 'Reservas ' + (filterStatus | titlecase) + 's' : 'Todas las Reservas (Excepto Pendientes)' }}
    </h2>

    <div *ngIf="isLoading && reservations.length === 0" class="p-8 text-center text-gray-500 dark:text-gray-400">
      <ion-spinner name="crescent" class="w-8 h-8"></ion-spinner>
      <p class="mt-2">Cargando reservas...</p>
    </div>
    <div *ngIf="!isLoading && reservations.length === 0 && !errorMessage" class="p-8 text-center text-gray-500 bg-white rounded-lg shadow-md dark:bg-kwd-darker dark:text-gray-400">
      <ion-icon name="calendar-clear-outline" class="w-12 h-12 mx-auto"></ion-icon>
      <p class="mt-2">No hay reservas para mostrar con los filtros actuales.</p>
    </div>
    <div *ngIf="errorMessage && !isLoading" class="p-4 my-4 text-sm text-center text-red-700 bg-red-100 rounded-lg dark:text-kwd-red dark:bg-red-900/30">
      {{ errorMessage }}
    </div>

    <ion-list *ngIf="!isLoading && reservations.length > 0" class="rounded-lg shadow-md dark:bg-kwd-darker">
      <ion-item *ngFor="let res of reservations" lines="full" class="dark:bg-kwd-darker dark:text-kwd-light">
        <ion-label>
          <h2 class="font-semibold">{{ res.classroom?.name || res.classroomId }}</h2>
          <p *ngIf="userRole === RolEnum.ADMIN">Usuario: {{ res.user?.name || res.user?.email || res.userId }}</p>
          <p>Desde: {{ res.startTime | date:'dd/MM/yy HH:mm' }}</p>
          <p>Hasta: {{ res.endTime | date:'HH:mm' }}</p>
          <p *ngIf="res.purpose" class="text-xs text-gray-500 dark:text-gray-400">Prop贸sito: {{ res.purpose }}</p>
        </ion-label>
        <div slot="end" class="flex flex-col items-center space-y-1">
          <ion-badge [color]="res.status === ReservationStatusEnum.CONFIRMADA ? 'success' : (res.status === ReservationStatusEnum.PENDIENTE ? 'warning' : (res.status === ReservationStatusEnum.CANCELADA ? 'medium' : 'danger'))" class="mb-1">
            {{ res.status.replace('_', ' ') | titlecase }}
          </ion-badge>
          <div class="flex space-x-1">
            <ion-button *ngIf="canEditReservation(res)" size="small" fill="clear" (click)="navigateToEditReservation(res.id)" color="primary">
              <ion-icon slot="icon-only" name="create-outline"></ion-icon>
            </ion-button>
            <ion-button *ngIf="canCancelReservation(res)" size="small" fill="clear" (click)="confirmAction(res, 'cancel', 'main')" color="warning">
              <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
            </ion-button>
            <ion-button *ngIf="canManageStatus(res)" size="small" fill="clear" (click)="confirmAction(res, 'approve', 'main')" color="success">
                <ion-icon slot="icon-only" name="checkmark-circle-outline"></ion-icon>
            </ion-button>
             <ion-button *ngIf="canManageStatus(res)" size="small" fill="clear" (click)="confirmAction(res, 'reject', 'main')" color="danger">
                <ion-icon slot="icon-only" name="ban-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-item>
    </ion-list>
  </div>
</ion-content>
